CREATE or alter FUNCTION GET_LATEST_PURCHASE_PRICE (product_id INTEGER,after_discount boolean,customer_id integer)
RETURNS DOUBLE PRECISION
AS
 declare tim DOUBLE PRECISION;
 declare Timh DOUBLE PRECISION;
 declare Ekptvsh DOUBLE PRECISION;
 declare Kvdikospelath INTEGER;

BEGIN
  
    SELECT FIRST 1
      ("Timh" - (("Timh" * "Ekptvsh") / 100)) AS tim,
      "Timh", "Ekptvsh", "pvlhseis"."Kvdikospelath"
    FROM
      "grammes",
      "pvlhseis",
      "eidhpar"
    WHERE
      "grammes"."Aapar" = "pvlhseis"."Aa"
      AND "pvlhseis"."Parastatiko" = "eidhpar"."Aa"
      AND ("eidhpar"."Xrevstiko" = 0 OR "eidhpar"."Xrevstiko" = 5)
      AND "eidhpar"."Emf_timvn" IN (1, 3)
      AND "grammes"."Eidos" = :product_id
      AND ("pvlhseis"."Aa" = :customer_id or :customer_id is null)
      AND ("pvlhseis"."Hmeromhnia" <= 'NOW')
      AND (
        ("eidhpar"."related_products" = 2 AND "grammes"."type" = 1)
        OR ("eidhpar"."related_products" = 3 AND "grammes"."type" = 2)
        OR "eidhpar"."related_products" < 2
        OR "eidhpar"."related_products" IS NULL
        OR "grammes"."type" IS NULL
        OR "grammes"."type" < 1
      )
    ORDER BY
      "pvlhseis"."Hmeromhnia" DESC,
      "grammes"."order" DESC
    INTO
      :tim,
      :Timh,
      :Ekptvsh,
      :Kvdikospelath  ;
 
 if (after_discount) then  return tim;
   else return Timh;
    
END
